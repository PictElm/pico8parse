<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>pico8parse</title>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
    <style>
      .hero-unit .nav-pills a {
        font-size: 70%;
        color: #797979;
        margin-top: 4px;
      }
      .hero-unit .nav-pills a:hover {
        text-decoration: underline;
      }
      h2, h3, h4 { margin-top: 1em; }
      @media only screen and (max-width: 800px) {
        #theme-toggle {
          width: 24px !important;
          height: 24px !important;
        }
      }
      #theme-toggle {
        float: right;
        width: 48px;
        height: 48px;
        border: 0px;
        background-size: 100% 100% !important;
        background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAATcSURBVGhD7ZpPSGVVHMdPKtIiQlxIYmBIRqKCgf8bsMUsEl0MkRnRoj+bwkXtBiyIwEjcuBkIiZiCURRdmDjooFCBgyMuRoanKMkDRVOEZ4KSo2j2/Z73O7d357373n33eq8N9IEfv985F57ne/7dc3/HZ1SW7O/vvwHXBmuEvQx7AUZ2YeuwB7C7hYWFv7IyaFwJQKPz4N6HfQFjo91AMd/A7kDMma4JgIwC0PgquNuwWl2RJaurq6q3t/evaDT6B4oUtQT7DTYXiUSO4H2RVgAaz17/HvasrvDIycmJ6uvrUzMzM1KjeQybhv0AIZO6xgO54pNA4z+HG4Bx+vgiLy9PtbS0qKOjI7WysiK1+ndfhb1XVFR0Axbb29uzHrolpQDpeTb+UmloaFC7u7tqfZ0zyQY3gncg4hpsHkL249WZSRKAxtfA/Qzz3fOpqK+vV/Pz8/w7UmOjDPYRRPzudjRsAvCjbPRd2Iu6IgA4nWpqatTExIS6uLiQWhv5MI5GHkT8Eq9yJke84RMYRyBQSktLVUdHh5Qc+bKqqqpfYkesEUDvPwc3CqMPnPLycjU+Pq7OztK+IhozjUTiCHDhmrdq4BQUFKjW1lYppYUj8bbESSQK+Fh8aLS18UTiitsQkfIEoAVg+rwE5+lN6wdOo5KSEimlhdP6u3hox4zAdfGhU1vrut+up5pKRkCD+NCpqKiQyBU8TNowAgLfOp0oK+O7yzU1GIV2iTVGQGi7z5PgqC2Ra2ybjREQ2Js3E9jnJXLNmxgF611lBDxN8Gh/LR4+nQJIi3hLwJb40MExQaKssDYdI4Af5FeCw7E6E9Zb2QiIiA+dzc1NibLC2jWNgAXxoZPwiZkNSbtQKDmcVCws+Os7LQAvk1V8p/6ta0IkGo2q7e1tKWUFMxoaMwJMecQkDI3paWZVPGFtOpaAqampR4eHh1IKHv6tyUnP6aBV8f8KODg4eDg0NCSl4BkbG9N5Io9Yu6YlANwfHh5WGxsbUgyOra0tNTg4KCVP3BdvEzB7fn7+uKenJ9OHti/42/wbp6enUpM1XMCz8TAhK4FX+ilOho2xWOwVTCfV3NwsTy6X/v5+NTc3JyVPTEcikZ8ktie2IOAY7t21tTV1fHys6urq4g8uiYGBATU6ysyNL26is61FbBPABxDB9EohVOpzClOBOTmJMy17OG3Y85fQ+HW0q0tijU0AgYA/4d5izJFYXFxU1dXVOo/jBW4K3d3dfqeN4TN08iOJNSnvB/DFMw/HKyRNfn6+am9vV52dnaq4uFhq07Ozs6NGRkb0Xu9jwSbyAL3fJLGFkwDm7R/CbBcbubm5OjHb1NSkKisrdU7HjAwXPo8Fy8vLOvu8tLSksKvpZ5cAd57XIMCa+wbHGxqI+ACOV0v/BT5E43+U2EbSGjBgri1hPbB7ral0RdxC47+VOAlHAQQi7kEEPx5CTzsK7PUutMPxpJxWAIGAe3DPw8IeiVuwLvR+2mNBxmtWg6wJJlh93Vi6gAv2U6c5/ySuBRDZnbiwgxoN3vJzwSbtNk5kJcAAIXxbfwVze2ufCV5bfo2G34kX3eNJgAFCbsAxV8n0fLZTy5wqedE9rms84EuAAUKYJaCI11mEcapx9zKi2Fh+BnJq8GOE5/lZNNz3vxr8z9Wi1D9cnJUKj6GpHQAAAABJRU5ErkJggg==');
      }
      /* dark theme */
      body.dark #theme-toggle {
        background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAUISURBVGhD7ZlbKHZZGMcfh+aLcchhHOKGhIRIEVE+SUOJzNVw5UrkcM2FzJUripRckItRDo3TyKmEyGk+5VhTyAUiwoiImG/Wf1n7nXe/+/Bupmym71e7vdZ697vf5/+utZ71rGfRR8dB3F9EdHR0ALtNsyuSN1gRFxdHzc3NoianpqaG5ufnRU3GCbs+b21t/flcNY6juBtGz3iQnJwsSkp0PuPvZO9WfaceLxJgz3iQlpYmSkpSUlJESZVXiTAswIjxQUFBFBwcLGpKfHx8KCoqStRUebEIQwKamppiMzMzv7Ci7ovt/MOcpKQkUdIkgPXiQktLS46o6+Ik7prA+IyMjD9yc3O9EhMT6ejoiE5OMOfkeHt7U3FxMfn7+4sWdTw9PWl6epru7+9Fy79ERERQbW0tFRUVubCe/Dk8PPzL6OjojvhYFV0vJBnPhsZ3oomzsLBAbW1ttL+/T6mpqZSXl0cJCQnk7OwsntDn8fGRVldXaWhoiHslDL2SkhJKT08XTzxzeXn599jYWG55efmoaFKgKUDLeAkYgZ7QG/NGODw8pICAAE3x9kSoDiF7xgNHR0fy8PAQtdeDd+BdWri4uDhgOIWEhCxNTEzsiWYLim/C2wwODv7m6+urafxb4+7u7jg5OfmrmneSCZBc5dnZWVh3d/dz4ztgZGSEDg4OfmBFhYu1CJCMZxd/oKenh66vr1E0ldvbW+rs7BQ15TrBBdgaD25ubqy/aBr4Iy8uLkSNIxMh9YDqCgs3By9hFufn59TX1ydqMqQ/3CJAYTx4eHjgPWEWbC7q/T5EyCexLYgeIyNVtb0J+G296BboCigoKBAl87Bng6YAxCwID8wGNsAWLXgowWb0V9zxIAI2RJXoOldXVzSbDlwpYifETYjDrq6ueDvbwTlwAfX19V9hMGJ1owGZmWxsbNDi4iJVV1c/C2B+lvfAR4OF8A66k/gj8E2A2XwTYDZ8R7a2tlZ3enpKDswp+fn56e6QzATb2PX1dRoYGKDGxkba29v7RbaQAbaF44tYVlaWoTTJW4DFa2pqivt+6+DOspBZC5DAqgyl72Fhy8/Pt90TcCBAc6xgucbybTbLy8uqxkvoDvb+/n5RMg9sqvTQFYAxZ+aO7Pj4WCsdb0ESoMwVMpAxQ9LJLAIDAyksLEzUFHCbJQGf2aUQUVZWZvokrqioECUZ/EAEBS5AnIzIRMTExOjm+t+K+Ph4vkexghsvneZY5oCtCCRb3wsYCU5OfM2VGQ9kk1gSkZmZ+VdsbOxz4zsgNDSUcnJysA1TnKPJBAA8wCZOEbLCosl0YAtzKIW2xgPV7DQOFXC4gKwwssOiWQbSjjjs8PLyEi2vY2fn+fxCa//9qvQ60BKBk5Wuri6qq6uj3t5e2t7eJjc3N+7yjAaBCMqWlpaQxqfW1lYaHh7mbXCZnz59Ek/9xwMOCZxVZWdn/44UN3sZtbe3qy7tiJ1gEMarHlgYS0tLLZkFa3BMVVhYyE98bm9v7RoPNHtAAj2Bw4WGhoYf2Qu/v7u7E5/IQc9gOMHt6TE+Pk5zc3OiJgfvXllZoZmZmTPWIz9VVVWNi480sdsDEiIbjISq5tKMIdDR0SFq6lRWVmL/IWqqKFylHsYGLUNyseyyLHa27O7uEjZGWmDib25uipoqLzIeGBYAjIjA5kMLBIdPT0+ipuDFxoMXCQD2RMzOzoqSEh1xrzL+fwDRP1Z7HWd0Q4j+AAAAAElFTkSuQmCC');
      }
      body.dark {
        background-color: #1e1e1e;
        color: #d4d4d4;
      }
      body.dark .hero-unit {
        background-color: #2c2c2c;
      }
      body.dark .nav>li>a:hover, body.dark .nav>li>a:focus {
        background-color: #2c2c2c;
      }
      body.dark code, body.dark pre, body.dark pre > code, body.dark textarea, body.dark select {
        background-color: #252526;
        border-color: #333;
        color: #d4d4d4;
      }
    </style>
    <style>
      /* PrismJS 1.25.0
      https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+json+typescript */
      body.bright code[class*=language-],body.bright pre[class*=language-]{color:#000;background:0 0;text-shadow:0 1px #fff;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}body.bright code[class*=language-] ::-moz-selection,body.bright code[class*=language-]::-moz-selection,body.bright pre[class*=language-] ::-moz-selection,body.bright pre[class*=language-]::-moz-selection{text-shadow:none;background:#b3d4fc}body.bright code[class*=language-] ::selection,body.bright code[class*=language-]::selection,body.bright pre[class*=language-] ::selection,body.bright pre[class*=language-]::selection{text-shadow:none;background:#b3d4fc}@media print{body.bright code[class*=language-],body.bright pre[class*=language-]{text-shadow:none}}body.bright pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}body.bright :not(pre)>code[class*=language-],body.bright pre[class*=language-]{background:#f5f2f0}body.bright :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}body.bright .token.cdata,body.bright .token.comment,body.bright .token.doctype,body.bright .token.prolog{color:#708090}body.bright .token.punctuation{color:#999}body.bright .token.namespace{opacity:.7}body.bright .token.boolean,body.bright .token.constant,body.bright .token.deleted,body.bright .token.number,body.bright .token.property,body.bright .token.symbol,body.bright .token.tag{color:#905}body.bright .token.attr-name,body.bright .token.builtin,body.bright .token.char,body.bright .token.inserted,body.bright .token.selector,body.bright .token.string{color:#690}body.bright .language-css .token.string,body.bright .style .token.string,body.bright .token.entity,body.bright .token.operator,body.bright .token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}body.bright .token.atrule,body.bright .token.attr-value,body.bright .token.keyword{color:#07a}body.bright .token.class-name,body.bright .token.function{color:#dd4a68}body.bright .token.important,body.bright .token.regex,body.bright .token.variable{color:#e90}body.bright .token.bold,body.bright .token.important{font-weight:700}body.bright .token.italic{font-style:italic}body.bright .token.entity{cursor:help}
    </style>
    <style>
      /* PrismJS 1.25.0
      https://prismjs.com/download.html#themes=prism-tomorrow&languages=markup+css+clike+javascript+json+typescript */
      body.dark code[class*=language-],body.dark pre[class*=language-]{color:#ccc;background:0 0;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}body.dark pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}body.dark :not(pre)>code[class*=language-],body.dark pre[class*=language-]{background:#2d2d2d}body.dark :not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}body.dark .token.block-comment,body.dark .token.cdata,body.dark .token.comment,body.dark .token.doctype,body.dark .token.prolog{color:#999}body.dark .token.punctuation{color:#ccc}body.dark .token.attr-name,body.dark .token.deleted,body.dark .token.namespace,body.dark .token.tag{color:#e2777a}body.dark .token.function-name{color:#6196cc}body.dark .token.boolean,body.dark .token.function,body.dark .token.number{color:#f08d49}body.dark .token.class-name,body.dark .token.constant,body.dark .token.property,body.dark .token.symbol{color:#f8c555}body.dark .token.atrule,body.dark .token.builtin,body.dark .token.important,body.dark .token.keyword,body.dark .token.selector{color:#cc99cd}body.dark .token.attr-value,body.dark .token.char,body.dark .token.regex,body.dark .token.string,body.dark .token.variable{color:#7ec699}body.dark .token.entity,body.dark .token.operator,body.dark .token.url{color:#67cdcc}body.dark .token.bold,body.dark .token.important{font-weight:700}body.dark .token.italic{font-style:italic}body.dark .token.entity{cursor:help}body.dark .token.inserted{color:green}
    </style>
  </head>
  <body>
    <div class="hero-unit">
      <div class="container">
        <div class="row">
          <div class="span6">
            <button id="theme-toggle" onclick="toggleTheme()"></button>
            <h1>pico8parse</h1>
            <p>A Lua parser written in JavaScript, with support for the PICO-8 flavour.<br/>Luaparse is originally written by Oskar Schöldström for his bachelor's thesis at Arcada.</p>
          </div>
          <div class="span6" style="padding-top: 35px;">
            <div class="btn-group">
              <a class="btn" href="https://github.com/PictElm/pico8parse">GitHub</a>
              <a class="btn" href="https://github.com/fstirlitz/luaparse">Original Project</a>
              <a class="btn" href="test/index.html">Tests</a>
              <a class="btn" href="playground.html">Playground</a>
            </div>
            <ul class="nav nav-pills">
              <li><a href="index.html">Home</a></li>
              <li><a href="upstream.html">About upstream</a></li>
              <li><a href="fork.html">About this fork</a></li>
              <li><a href="coverage.html">Coverage</a></li>
              <li><a href="examples.html">Examples</a></li>
              <li><a href="ast-nodes.html">AST nodes</a></li>
              <li><a href="features.html">Features (for Lua versions)</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
<h1 id="support-for-the-pico-8-flavour-of-lua">Support for the PICO-8 Flavour of Lua</h1>
<p>The PICO-8 Lua is based of the 5.2 version of the Lua language, a such most 5.2 syntaxes and behavior are present in PICO-8 Lua.</p>
<p>The values added for the parser <code>luaVersion</code> option are:</p>
<ul>
<li><code>&#39;PICO-8&#39;</code> (should not be used, just for feature inheritance)</li>
<li><code>&#39;PICO-8-0.2.1&#39;</code></li>
<li><code>&#39;PICO-8-0.2.2&#39;</code> (adds support for some escape sequences)</li>
<li><code>&#39;PICO-8-0.2.3&#39;</code> (empty <code>if</code>/<code>while</code>, <code>?</code> on same line)</li>
<li><code>&#39;PICO-8-0.2.4&#39;</code> (any character before <code>if</code>/<code>while</code>)</li>
</ul>
<p>If the targeted version is not in this list, the closest preceding version should have the same syntaxes.</p>
<blockquote>
<p>TL;DR: PICO-8 Lua differs from standard Lua because it is preprocessed; for example the <code>&#39;?&#39;</code> &quot;operator&quot; is simply replaced with <code>&#39; print(&#39;</code>. The way this is done introduces many cursed syntaxes (and I don&#39;t want to maintain a list of these). To see the result of this preprocessing you can use <a href="https://gist.github.com/PictElm/b85467b379d676481e6a4483ee2ef5a0">this same trick</a> (until fixed) with a cartridge containing exactly:</p>
<pre><code>pico-8 cartridge

__lua__
printh[=[
#include file_with_code_to_inspect
]=]
</code></pre>
</blockquote>
<h2 id="miscellaneous">Miscellaneous</h2>
<h3 id="not-covered--inaccuracies">Not Covered / Inaccuracies</h3>
<p>These changes (specific to PICO-8&#39;s Lua) have been considered out of scope:</p>
<ul>
<li>the <code>#include ..</code> directive</li>
<li>edge cases like ending the <code>__lua__</code> section with <code>local a,</code></li>
</ul>
<p>Differences with the official interpreter for PICO-8 version 0.2.1:</p>
<ul>
<li>&quot;preprocessor can not handle form <code>::_::a+=1</code>&quot; (gives a funny <code>syntax error expected near &#39;+&#39;</code>)</li>
<li>&quot;preprocessor: self assignment with quoted function calls on RHS <code>a+=1+cos&quot;0&quot;</code>&quot; (<code>runtime error attempt to perform arithmetic on global &#39;cos&#39; [...]</code>)</li>
<li>... and other unexpected behaviors (mainly around <code>+=</code> and such, stare at PICO-8&#39;s changelogs for more of these)</li>
</ul>
<h3 id="comments">Comments</h3>
<p>PICO-8 Lua reads <code>//</code> as a single line comment (similarly to C-inspired languages). Do note that this is not a simple alias for <code>--</code> as it will not start a longstring comment:</p>
<!-- 'js' just for colors -->
<pre><code class="language-js">// comment

//[[ comment
  not comment,
  but syntax error
]]
</code></pre>
<p>Adding to the list of changes to comments, longstring comments cannot use the <code>=</code> as depth:</p>
<pre><code>--[==[ comment
  not comment but syntax error
  (no MD highlight to show that)
]==]
</code></pre>
<p>This syntax is kept for actual strings:</p>
<pre><code class="language-lua">local text = [==[hey
how&#39;s it going?]==]
print(text)
</code></pre>
<h2 id="numerals">Numerals</h2>
<h3 id="binary-literal">Binary Literal</h3>
<p>PICO-8 accepts binary notation for numeral the same way Lua 5.2+ does for hexadecimal:</p>
<ul>
<li><code>0b101010</code>: 42</li>
<li><code>0b0.1</code>: 0.5</li>
<li><code>0b10.</code>: 2.</li>
<li><code>0b.01</code>: .125</li>
</ul>
<h3 id="no-exponent-no-complex-no-unsigned-nor-long">No Exponent, no Complex, no Unsigned nor Long</h3>
<p>Lua numerals can consist of trailing &quot;U&quot;, &quot;I&quot; and &quot;L&quot;s, none of which is a supported notation for PICO-8. The same way, the exponential and binary exponential notations are seen as error:</p>
<ul>
<li><code>2.1i</code></li>
<li><code>4U</code></li>
<li><code>0xB0p99</code></li>
<li><code>0.31416E1</code></li>
<li>and so on...</li>
</ul>
<h2 id="operators">Operators</h2>
<h3 id="unary-operators">Unary Operators</h3>
<p>The following are unary operators on a number (with the same precedence as <code>-</code>, <code>~</code> and <code>not</code>):</p>
<ul>
<li><code>@</code> example <code>@0x2000</code></li>
<li><code>$</code> example <code>$-1</code></li>
<li><code>%</code> example <code>%100</code></li>
</ul>
<h3 id="binary-operators">Binary Operators</h3>
<p>Here is a set of bitwise operators (so on numbers)</p>
<ul>
<li>logical shift right: <code>&gt;&gt;&gt;</code> (ignores the sign)</li>
<li>rotate left: <code>&lt;&lt;&gt;</code></li>
<li>rotate right: <code>&gt;&gt;&lt;</code></li>
<li>the bitwise xor from Lua (<code>~</code>) is replaced with the token <code>^^</code></li>
</ul>
<p>The Lua integer division (usually written <code>//</code>) represents a single line comment in PICO-8 so the <code>\</code> is used instead.</p>
<p>This flavour also implement the <code>!=</code> as an alias for <code>~=</code>.</p>
<p>The shift and rotates have the same precedence as Lua&#39;s shift operators <code>&lt;&lt;</code> and <code>&gt;&gt;</code>. The exclusive or, not-equal and integer division keep the same precedence.</p>
<h3 id="assignment-operations">Assignment Operations</h3>
<p>Every binary operator that is not a comparison have an assignment syntax. The full list is:</p>
<table>
<thead>
<tr>
<th>assignment</th>
<th>equivalent</th>
</tr>
</thead>
<tbody><tr>
<td><code>a += b</code></td>
<td><code>a = a + b</code></td>
</tr>
<tr>
<td><code>a -= b</code></td>
<td><code>a = a - b</code></td>
</tr>
<tr>
<td><code>a *= b</code></td>
<td><code>a = a * b</code></td>
</tr>
<tr>
<td><code>a /= b</code></td>
<td><code>a = a / b</code></td>
</tr>
<tr>
<td><code>a \= b</code></td>
<td><code>a = a \ b</code></td>
</tr>
<tr>
<td><code>a %= b</code></td>
<td><code>a = a % b</code></td>
</tr>
<tr>
<td><code>a ^= b</code></td>
<td><code>a = a ^ b</code></td>
</tr>
<tr>
<td><code>a ..= b</code></td>
<td><code>a = a .. b</code></td>
</tr>
<tr>
<td><code>a |= b</code></td>
<td><code>a = a | b</code> <!-- the back-slash is only here because it breaks the table otherwise --></td>
</tr>
<tr>
<td><code>a &amp;= b</code></td>
<td><code>a = a &amp; b</code></td>
</tr>
<tr>
<td><code>a ^^= b</code></td>
<td><code>a = a ^^ b</code></td>
</tr>
<tr>
<td><code>a &lt;&lt;= b</code></td>
<td><code>a = a &lt;&lt; b</code></td>
</tr>
<tr>
<td><code>a &gt;&gt;= b</code></td>
<td><code>a = a &gt;&gt; b</code></td>
</tr>
<tr>
<td><code>a &gt;&gt;&gt;= b</code></td>
<td><code>a = a &gt;&gt;&gt; b</code></td>
</tr>
<tr>
<td><code>a &lt;&lt;&gt;= b</code></td>
<td><code>a = a &lt;&lt;&gt; b</code></td>
</tr>
<tr>
<td><code>a &gt;&gt;&lt;= b</code></td>
<td><code>a = a &gt;&gt;&lt; b</code></td>
</tr>
</tbody></table>
<p>It must be noted that for this syntax to be implemented, a new type of AST node was added under the name of <code>&#39;AssignmentOperatorStatement&#39;</code>. These present the properties <code>variables</code> and <code>init</code> of an <code>&#39;AssignmentStatement&#39;</code> as well as the <code>operator</code> of a <code>&#39;BinaryExpression&#39;</code> node.</p>
<h2 id="single-line-statements">Single Line Statements</h2>
<blockquote>
<p>Important notice: this feature introduces a meaning to a new-line sequence, which is a blank character and get ignored by Lua.</p>
</blockquote>
<h3 id="idea">Idea</h3>
<p>This syntax introduce the possibility to write certain block without having to specify its bounds using tokens, similarly to some other languages (for example an <code>if</code> statement in JavaScript do no need curly brackets when its body consists of only one &quot;line&quot; of instructions).</p>
<pre><code class="language-lua">if (condition) instruction1()
instruction2()

-- is semantically the same as

if condition then instruction1() end instruction2()
</code></pre>
<pre><code class="language-lua">if (condition) instruction1() else instruction2()

-- is semantically the same as

if condition then instruction1() else instruction2() end
</code></pre>
<pre><code class="language-lua">while (condition) instruction()

-- is semantically the same as

while condition do instruction() end
</code></pre>
<p>Notice how:</p>
<ul>
<li>the parenthesis enclosing the condition are necessary</li>
<li>this syntax of the <code>if</code> statement cannot present an <code>elseif</code> clause</li>
<li>no instruction are present after the syntax <em>on the same line</em></li>
</ul>
<h3 id="quirks">Quirks</h3>
<p>While this change initially only apply to the <code>if</code> and <code>while</code> statements, its actual implementation in the PICO-8 Lua runtime leads to unexpectedly correct or incorrect syntaxes which also impacts the standard <code>do</code>, <code>function</code> and <code>for</code> amongst other things.</p>
<p>Without any evidences to back the following claims as to how PICO-8 parses its Lua, testings have shown that the behavior of the actual implementation are similar to applying the following preprocessing to the raw script:</p>
<p>If a line contains an <code>if</code> token (resp. <code>while</code>) which does not present an associated <code>then</code> token (resp. <code>do</code>) right after its condition, the very next new-line sequence (or if lack thereof, end-of-file) is treated as an <code>end</code> token. This <code>end</code> token is in no way associated with the opened <code>if .. then</code> statement&#39;s body block (resp. <code>do .. while</code>) and essentially gives any end-of-lines <em>potentially</em> the meaning of an <code>end</code> token.</p>
<p>This gives rise to a bunch of cursed valid syntaxes (try to guess the scopes):</p>
<table>
<tr><th>PICO-8 Syntax</th><th>Result of Preprocess</th></tr>
<tr>
<td>

<pre><code class="language-lua">if (cdt) do
end
</code></pre>
</td>
<td>

<pre><code class="language-lua">if cdt then do end
end
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code class="language-lua">if (cdt) end do
</code></pre>
</td>
<td>

<pre><code class="language-lua">if cdt then end do end
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code class="language-lua">if (cdt) end function fun()
</code></pre>
</td>
<td>

<pre><code class="language-lua">if cdt then end function fun() end
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code class="language-lua">-- incorrect!
if (cdt1) end while (cdt2) instr() do

-- correct!
if (cdt1) end while (cdt2) do instr()
</code></pre>
</td>
<td>

<pre><code class="language-lua">-- indeed... weird
if cdt1 then end while cdt2 instr() do end

-- correct!
if cdt1 then end while cdt2 do instr() end
</code></pre>
</td>
</tr>
</table>

<blockquote>
<p>Note for slimmer screens: outside of the first row, all are on a single line.</p>
</blockquote>
<h3 id="additionally">Additionally</h3>
<p>This syntax of &quot;single line&quot; statements also comes with an arbitrary rule that the character preceding the <code>if</code> (or <code>while</code>) token must be either:</p>
<ul>
<li>a blank character (whitespace, tabulation, newline sequence)</li>
<li>a numeral: <code>a = 0xfif (cdt) instr()</code> is valid (and <code>a</code> is 15)</li>
<li>a multiline comment <strong>only</strong> if one of these 2 points is valid before it</li>
</ul>
<pre><code class="language-lua">-- invalid
instr()--[[]]if (cdt) instr()
instr()--[[]]--[[]]if (cdt) instr()
instr() --[[]]--[[]]if (cdt) instr()

-- valid
instr() --[[]]if (cdt) instr()
instr()--[[]] if (cdt) instr()
a = 0xf--[[]]if (cdt) instr()
</code></pre>
<p>This dependency on the preceding character/token was removed in version 0.2.4 (making every lines above valid, even without comments).</p>
<p>Finally, it is important to notice that the body of the clause cannot be empty. Or maybe just sometimes. To be more specific, a single line <code>if</code> or <code>while</code> with no instruction following (before end-of-line) is not considered valid, but a single line <code>if</code> containing an <code>else</code> clause (albeit empty) is valid.</p>
<pre><code class="language-lua">-- invalid
while (cdt)
if (cdt)

-- valid
while (cdt) instr()
if (cdt) instr()
if (cdt) else instr()

-- also valid
if (cdt) else
</code></pre>
<p>This was changed in version 0.2.3, above which the following is made possible:</p>
<pre><code class="language-lua">-- valid
while (cdt) ;

-- still invalid
while (cdt)
</code></pre>
<h2 id="print-shorthand">Print Shorthand</h2>
<p>The special character <code>?</code> acts as a short hand for the <code>print</code> function. As such, it does expect a parameter list as its following tokens</p>
<p>Example: <code>? &quot;text&quot;, 1, 2, 3</code> is equivalent to <code>print(&quot;text&quot;, 1, 2, 3)</code>.</p>
<p>However the implementation of it is somewhat capricious and very new-line dependent:</p>
<ul>
<li>nothing can precede the <code>?</code> character except a multiline comment</li>
<li>the rest of the line past the <code>?</code> must be a valid parameter list</li>
<li>it does not expect the parameter list to be enclosed in parenthesis</li>
</ul>
<pre><code class="language-lua">-- invalid
instr() ?&quot;text&quot;
?&quot;text&quot; ; instr()
?(&quot;text&quot;, 1)

-- still invalid
instr()    --[[]]    ?&quot;text&quot;

-- valid
?&quot;text&quot;
--[[]]?&quot;text&quot;
?(&quot;text&quot;), (1)
</code></pre>
<p>Although from version 0.2.3 onward, this was changed to allow the <code>?</code> &quot;operator&quot; to appear on the same line as a single line <code>if</code>/<code>while</code>, making the following valid:</p>
<pre><code class="language-lua">-- valid
if (cdt) ?&quot;text&quot;
instr() ?&quot;text&quot;

-- also valid
??&quot;text&quot;) -- what?
</code></pre>
<p>The actual behavior of the preprocessor regarding the <code>?</code> is rather simple and explains that last line:</p>
<ul>
<li>a valid <code>?</code> is replaced with exactly <code> print(</code></li>
<li>this marks the end of the line for <em>a single parenthesis</em></li>
</ul>
<p>Therefor <code>?&quot;text&quot;</code> translates to <code> print(&quot;text&quot;)</code> and <code>??&quot;text&quot;</code> would only translate to <code> print( print(&quot;text&quot;)</code> (only one closing parenthesis).</p>
<h2 id="p8scii">P8SCII</h2>
<blockquote>
<p>Remark: this feature is only available when specifying a version above <code>&#39;PICO-8-0.2.2&#39;</code> and might be erroneous in some places.</p>
</blockquote>
<p>A new set of escape sequences become valid in PICO-8:</p>
<ul>
<li><code>\*</code></li>
<li><code>\+</code></li>
<li><code>\-</code></li>
<li><code>\|</code></li>
<li><code>\#</code></li>
<li><code>\^</code></li>
</ul>
<p>The following sequence are already valid in Lua 5.2 and thus are not modified, but they get a mention as their meaning was changed (and maybe their validation pattern too):</p>
<ul>
<li><code>\a</code> &quot;audio&quot;</li>
<li><code>\v</code> decorate previous character</li>
<li><code>\f</code> set foreground colour</li>
<li><code>\014</code> switch to font defined at 0x5600</li>
<li><code>\015</code> switch to default font</li>
</ul>
<h1 id="support-for-the-pico-8-associated-file-format-p8-text">Support for the PICO-8 Associated File Format (.p8, text)</h1>
<p>Scripts in the PICO-8 Lua flavour are usually part of .p8 files. The convoluted definition for this file format is described bellow. Only &#39;PICO-8-x.y.z&#39; <code>luaVersion</code>s are expected to be .p8 files (via the <code>strictP8FileFormat</code> feature inherited from the abstract version &#39;PICO-8&#39;). Despite that, the <code>ignoreStrictP8FileFormat</code> parser option may be used to ignore some behaviors.</p>
<blockquote>
<p>Uh.. note: as per the current implementation of <code>ignoreStrictP8FileFormat</code>, only the header check is ignored and the stream is assumed to start in a <code>&#39;__lua__&#39;</code> section; but further section-starting sequences <strong>are still accounted for</strong>.</p>
</blockquote>
<h2 id="overall-format">Overall Format</h2>
<p>A typical .p8 file starts with the following 2-lines header:</p>
<pre><code>pico-8 cartridge // http://www.pico-8.com
version VER
</code></pre>
<p>Where <code>VER</code> is a numeric version (decimal integer, no leading sign or zeros).</p>
<p>It may then consists of up to 7 sections all introduced in order by their respective sequence:</p>
<pre><code>__lua__
__gfx__
__gff__
__label__
__map__
__sfx__
__music__
</code></pre>
<p>The sequence is usually found alone on its line, with no other character (except for EOL). The associated section then starts from the following line until the next section or EOF.</p>
<p>Of these 7 section, only the <code>&#39;__lua__&#39;</code> one consists of actual valid Lua code.</p>
<h3 id="more-about-the-header">More About the Header</h3>
<p>The exact definition that makes a .p8 file&#39;s header valid is looser than introduced above: as long as the string <code>&quot;pico-8 cartridge&quot;</code> (16 characters, case sensitive) is present on the first line, the rest of the file is parsed fine.</p>
<p>But in addition to checking the first line, the very next one is entirely discarded (it typically contains the <code>version VER</code> mention). This behavior makes it so if it contains one of the 7 sequences presented above, it will not count as staring a section.</p>
<p>Past these 2 lines, any character is discarded until a valid section starts (se bellow).</p>
<h3 id="more-about-sections">More About Sections</h3>
<blockquote>
<p>As shown above, all section-starting sequences are similar in syntax to Python&#39;s dunder, <code>&#39;__xyz__&#39;</code> and <code>&#39;__abc__&#39;</code> are used here to specify any of those.</p>
</blockquote>
<p>When reading a .p8 file line-be-line, a new section starts when a line starts by a sequence from the list above. This lines is then silently discarded. Because only these first few characters are checked:</p>
<ul>
<li>any character after the <code>&#39;__xyz__&#39;</code> but <em>before</em> the EOL are effectively discarded</li>
<li>any character before the <code>&#39;__xyz__&#39;</code> invalidates the check, no new section is started</li>
<li>this check for a section stating <strong>is not context-aware</strong> (neither what sections is, nor what section were)</li>
</ul>
<p>The various sections of a .p8 files does not have to be present in the same order as listed above. Beyond that, they do no have to be present at all as much as they can be present multiple times:</p>
<pre><code>__xyz__
content of section xyz

__abc__
content of section abc

__xyz__
content AGAIN of section xyz
</code></pre>
<p>When a file presents multiple sections under the same <code>&#39;__xyz__&#39;</code>, their content is essentially concatenated (line-wise). The snippet above is equivalent to this (note the newlines):</p>
<pre><code>__xyz__
content of section xyz

content AGAIN of section xyz
__abc__
content of section abc
</code></pre>
<blockquote>
<p>Although the section <code>&#39;__xyz__&#39;</code> now shows an empty line, it is important to note that each section also have their own set of internal rules, to which empty lines may be removed.</p>
</blockquote>
<p>Coming back to parsing Lua, all this means that the following sources get effectively parsed somewhat unexpectedly:</p>
<table>
<tr><th>Actual File Content</th><th>Result of Preprocess</th></tr>
<tr>
<td>

<pre><code>pico-8 cartridge
__lua__
a = [[
__gfx__
bonjour
]]
__lua__
]]
</code></pre>
</td>
<td>

<pre><code>pico-8 cartridge
__lua__
a = [[
]]
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code>pico-8 cartridge
__lua__
__lua__ = 42
print(__lua__)
</code></pre>
</td>
<td>

<pre><code>pico-8 cartridge
__lua__
print(__lua__)
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code>pico-8 cartridge
--[[ how to write
documentation for
__lua__ PICO-8? ]]
print(&quot;coucou&quot;)
</code></pre>
</td>
<td>

<pre><code>pico-8 cartridge
__lua__
print(&quot;coucou&quot;)
</code></pre>
</td>
</tr>
<tr>
<td>

<pre><code>pico-8 cartridge
with no section
at all
</code></pre>
</td>
<td>

<pre><code>pico-8 cartridge
</code></pre>
</td>
</tr>
</table>

    </div>
    <script src="util/PrismJS-1.25.0.js"></script>
    <script>
      /* jshint browser: true */
      function toggleTheme() {
        var other = { bright: "dark", dark: "bright", null: localStorage.getItem('theme') || "dark" }
          , body = document.body
          , theme = other[body.getAttribute('class')];
        localStorage.setItem('theme', theme);
        body.setAttribute('class', theme);
      }
      toggleTheme();
    </script>
  </body>
</html>
